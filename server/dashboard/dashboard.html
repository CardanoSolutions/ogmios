<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Ogmios</title>

    <link rel="stylesheet" href="css/spectre/0.5.9/core.css" />
    <link rel="stylesheet" href="css/spectre/0.5.9/exp.css" />
    <link rel="stylesheet" href="css/style.css" />

    <link rel="shortcut icon" href="img/favicon.png" type="image/png" />

    <script src="js/chart.js/4.3.3/core.js"></script>
    <script src="js/app.js"></script>
  </head>
  <body style="height: calc(100vh);">
    <header class="navbar py-1 px-2">
      <section class="navbar-section">
        <a href="/" class="navbar-brand mr-2">Ogmios <small><span id="version"></span></small></a>
      </section>
      <section class="navbar-section">
        <a target="_blank" href="https://ogmios.dev/api" class="btn btn-link text-small flex-c-c">
          <svg class="feather mr-1" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
            <path d="M4 19.5A2.5 2.5 0 0 1 6.5 17H20"></path><path d="M6.5 2H20v20H6.5A2.5 2.5 0 0 1 4 19.5v-15A2.5 2.5 0 0 1 6.5 2z"></path>
          </svg>
          API reference
        </a>
        <a target="_blank" href="https://ogmios.dev/changelog" class="btn btn-link flex-c-c text-small">
          <svg class="feather mr-1" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
            <line x1="8" y1="6" x2="21" y2="6"></line><line x1="8" y1="12" x2="21" y2="12"></line><line x1="8" y1="18" x2="21" y2="18"></line><line x1="3" y1="6" x2="3.01" y2="6"></line><line x1="3" y1="12" x2="3.01" y2="12"></line><line x1="3" y1="18" x2="3.01" y2="18"></line>
          </svg>
          Changelog
        </a>
        <a target="_blank" href="https://github.com/CardanoSolutions/ogmios" class="btn btn-link text-small flex-c-c">
          <svg class="feather mr-1" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
            <path d="M9 19c-5 1.5-5-2.5-7-3m14 6v-3.87a3.37 3.37 0 0 0-.94-2.61c3.14-.35 6.44-1.54 6.44-7A5.44 5.44 0 0 0 20 4.77 5.07 5.07 0 0 0 19.91 1S18.73.65 16 2.48a13.38 13.38 0 0 0-7 0C6.27.65 5.09 1 5.09 1A5.07 5.07 0 0 0 5 4.77a5.44 5.44 0 0 0-1.5 3.78c0 5.42 3.3 6.61 6.44 7A3.37 3.37 0 0 0 9 18.13V22"></path>
          </svg>
          Source code
        </a>
      </section>
    </header>

    <div class="container flex-c-c" style="height: 100%;">

      <script>
        on(EVENTS.DASHBOARD_ERROR, (e) => {
          sel('body').style.height = '100vh';
          sel('div#loading').classList.add('d-none');
          sel('div#dashboard').classList.add('d-none');
          sel('div#empty').classList.remove('d-none');
          sel('div#empty pre.error').innerHTML = JSON.stringify(e, null, 2);
        });

        on(EVENTS.DASHBOARD_READY, (e) => {
          sel('body').style.height = 'auto';
          sel('div#loading').classList.add('d-none');
          sel('div#empty').classList.add('d-none');
          sel('div#dashboard').classList.remove('d-none');
        });
      </script>

      <div id="loading" class="loading loading-lg"></div>

      <div id="empty" class="empty flex-c-c flex-col d-none" style="width: 100%; height: 100%;">
        <div class="empty-icon">
          <svg class="feather" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
            <polygon points="7.86 2 16.14 2 22 7.86 22 16.14 16.14 22 7.86 22 2 16.14 2 7.86 7.86 2"></polygon><line x1="12" y1="8" x2="12" y2="12"></line><line x1="12" y1="16" x2="12.01" y2="16"></line>
          </svg>
        </div>
        <p class="empty-title h5">Ho no, the situation is <strong class="text-error">catastrophic!</strong></p>
        <p class="empty-subtitle">The dashboard is unable to connect to the server. Try to refresh the page, and <u>if the error persists</u>, please contact project maintainers with the following details:</p>
        <pre class="error"></pre>
        <div class="empty-action">
          <a href="https://github.com/CardanoSolutions/ogmios/issues/new?template=bug.yaml" target="_blank" class="btn btn-primary">Open an issue</a>
        </div>
      </div>

      <div id="dashboard" class="columns d-none">

        <div class="column col-12 my-2"><div class="divider text-center" data-content="ERA PROGRESSION"></div></div>

        <!--------------- Era progression -->
        <div class="column col-2 col-mx-auto"></div>
        <div class="column col-8 col-mx-auto">
          <ul class="step">
            <li id="byron" class="era step-item">
              <a>Byron</a>
            </li>
            <li id="shelley" class="era step-item">
              <a>Shelley</a>
            </li>
            <li id="allegra" class="era step-item">
              <a>Allegra</a>
            </li>
            <li id="mary" class="era step-item">
              <a>Mary</a>
            </li>
            <li id="alonzo" class="era step-item">
              <a>Alonzo</a>
            </li>
            <li id="babbage" class="era step-item">
              <a>Babbage</a>
            </li>
            <li id="conway" class="era step-item">
              <a>Conway</a>
            </li>
          </ul>
        </div>
        <div class="column col-2 col-mx-auto"></div>

        <div class="column col-12 my-2"><div class="divider text-center" data-content="MONITORING"></div></div>

        <!--------------- Health -->
        <div class="column col-1"></div>
        <div class="column col-4 col-mx-auto flex-col">

          <div class="card">
            <div class="card-header">
              <div class="card-title h5">Entrypoints</div>
              <div class="card-subtitle text-gray">A brief summary of the server's entrypoints.</div>
            </div>
            <div class="card-body columns flex-c-c text-monospace text-small">
              <span id="websocket-url" class="label label-secondary p-1 px-2 mr-1"></span>
              <span id="http-url" class="label label-secondary p-1 px-2 ml-1"></span>
              <script>
                on(EVENTS.ENTRYPOINTS, ({ websocketUrl, httpUrl }) => {
                  sel('#websocket-url').innerText = websocketUrl;
                  sel('#http-url').innerText = httpUrl;
                })
              </script>
            </div>
          </div>

          <div class="card" style="margin-top: auto;">
            <div class="card-header">
              <div class="card-title h5">Health</div>
              <div class="card-subtitle text-gray">Check here if Ogmios is connecting to your node and if your node is correctly syncing with the network.</div>
            </div>
            <div class="card-body columns">

              <div class="column col-1"></div>
              <div class="column col-5 my-2">
                <span class="chip bg-primary py-1">
                  <svg class="feather mr-2 py-1 s-rounded" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                    <path d="M18.36 6.64a9 9 0 1 1-12.73 0"></path><line x1="12" y1="2" x2="12" y2="12"></line>
                  </svg>
                  <span style="font-variant: small-caps;">Status</span>
              </div>
              <div class="column col-5 my-2 text-right">
                <span id="status" class="label label-rounded">?</span>
              </div>
              <div class="column col-1"></div>

              <div class="column col-1"></div>
              <div class="column col-5 my-2">
                <span class="chip bg-primary py-1">
                  <svg class="feather mr-2 py-1 s-rounded" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                    <path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"></path><circle cx="12" cy="7" r="4"></circle>
                  </svg>
                  <span style="font-variant: small-caps;">Active clients</span>
              </div>
              <div class="column col-5 my-2 text-right">
                <span id="active-connections">?</span>
              </div>
              <div class="column col-1"></div>

              <div class="column col-1"></div>
              <div class="column col-5 my-2">
                <span class="chip bg-primary py-1">
                  <svg class="feather mr-2 py-1 s-rounded" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                    <circle cx="12" cy="12" r="10"></circle><polyline points="12 6 12 12 16 14"></polyline>
                  </svg>
                  <span style="font-variant: small-caps;">Last known tip</span>
                </span>
              </div>
              <div class="column col-5 my-2 text-right">
                <span id="last-update" class="badge px-2 text-monospace" data-badge="?"></span>
              </div>
              <div class="column col-1"></div>

              <div class="column col-1"></div>
              <div class="column col-5 my-2">
                <span class="chip bg-primary py-1">
                  <svg class="feather mr-2 py-1 s-rounded" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                    <polyline points="22 12 18 12 15 21 9 3 6 12 2 12"></polyline>
                  </svg>
                  <span style="font-variant: small-caps;">Network</span>
              </div>
              <div class="column col-5 my-2 text-right">
                <span id="network-synchronization" class="badge px-2" data-badge="?"></span>
              </div>
              <div class="column col-1"></div>
            </div>
          </div>
        </div>
        <script>
          on(EVENTS.HEALTH_TICK, (health) => {
            const status = sel('#status')

            status.innerText = health.connectionStatus;
            if (health.connectionStatus === 'connected') {
              status.classList.add('label-success');
              status.classList.remove('label-error');
            } else {
              status.classList.remove('label-success');
              status.classList.add('label-error');
            }

            sel('#last-update').innerText = health.lastKnownTip?.slot ?? '?';
            sel('#last-update').setAttribute('data-badge', lastUpdate(health.lastTipUpdate));
            sel('#network-synchronization').setAttribute('data-badge', percentage(health.networkSynchronization));
            sel('#network-synchronization').innerText = health.network;
            sel('#active-connections').innerText = health.metrics?.activeConnections ?? '?';
            sel('#version').innerText = `－${health.version}`
            all('.era').forEach(era => {
              const currentEra = (health.currentEra || "Byron").toLowerCase();
              if (era.id === currentEra) {
                era.classList.add('active')
              } else {
                era.classList.remove('active')
              }
            });
          })
        </script>

        <!--------------- Memory Usage -->
        <div class="column col-6">
          <div class="card">
            <div class="card-header">
              <div class="card-title h5">Memory Usage</div>
              <div class="card-subtitle text-gray">Real-time view of Ogmios heap size. This should remain relatively low.</div>
            </div>
            <div class="card-body">
              <div style="position: relative;"><canvas id="max-heap-size"></canvas></div>
              <script>
                window.charts = {}

                charts.currentHeapSize = new Chart(document.querySelector('canvas#max-heap-size').getContext('2d'), {
                  type: 'line',
                  options: {
                    tooltips: { mode: 'index', intersect: false },
                    hover: { mode: 'nearest', intersect: true },
                    backgroundColor: '#5755d9',
                    borderColor: '#5755d9',
                  },
                  data: {
                    labels: [],
                    datasets: [{
                      label: 'Heap size (KB)',
                      fill: true,
                      data: [],
                    }]
                  },
                });

                window.addEventListener("resize", debounce(() => charts.currentHeapSize.resize(), 50));
              </script>
            </div>
          </div>
        </div>
        <script>
          on(EVENTS.HEALTH_TICK, ({ metrics } ) => {
            const x = timestamp();
            const y = metrics.runtimeStats.currentHeapSize;
            addPoint(charts.currentHeapSize, x, y);
          });
        </script>
        <div class="column col-1"></div>
      </div>
    </div>
  </body>
</html>
