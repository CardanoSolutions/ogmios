<!doctype html><html lang=en class="js csstransforms3d"><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta name=generator content="Hugo 0.76.5"><meta name=description content="User manual for Ogmios, a lightweight protocol translation service for Cardano."><meta name=author content="KtorZ <matthias.benkort@gmail.com>"><link rel=icon href=/cardano-ogmios/images/favicon.png type=image/png><title>Local Chain Sync - Ogmios</title><link href=/cardano-ogmios/css/nucleus.css?1603821225 rel=stylesheet><link href=/cardano-ogmios/css/fontawesome-all.min.css?1603821225 rel=stylesheet><link href=/cardano-ogmios/css/hybrid.css?1603821225 rel=stylesheet><link href=/cardano-ogmios/css/featherlight.min.css?1603821225 rel=stylesheet><link href=/cardano-ogmios/css/perfect-scrollbar.min.css?1603821225 rel=stylesheet><link href=/cardano-ogmios/css/auto-complete.css?1603821225 rel=stylesheet><link href=/cardano-ogmios/css/atom-one-dark-reasonable.css?1603821225 rel=stylesheet><link href=/cardano-ogmios/css/theme.css?1603821225 rel=stylesheet><link href=/cardano-ogmios/css/hugo-theme.css?1603821225 rel=stylesheet><script src=/cardano-ogmios/js/jquery-3.3.1.min.js?1603821225></script><style>:root #header+#content>#left>#rlblock_left{display:none!important}</style></head><body data-url=/cardano-ogmios/mini-protocols/local-chain-sync/><nav id=sidebar><div id=header-wrapper><div id=header><a href=/cardano-ogmios><img alt=ogmios src=/cardano-ogmios/ogmios-logo-white.png></a></div><div class=searchbox><label for=search-by><i class="fas fa-search"></i></label><input data-search-input id=search-by type=search placeholder=Search...>
<span data-search-clear><i class="fas fa-times"></i></span></div><script type=text/javascript src=/cardano-ogmios/js/lunr.min.js?1603821225></script><script type=text/javascript src=/cardano-ogmios/js/auto-complete.js?1603821225></script><script type=text/javascript>var baseurl="https:\/\/ktorz.github.io\/cardano-ogmios\/";</script><script type=text/javascript src=/cardano-ogmios/js/search.js?1603821225></script></div><div class=highlightable><ul class=topics><li data-nav-id=/cardano-ogmios/getting-started/ title="Getting Started" class=dd-item><a href=/cardano-ogmios/getting-started/><b>1. </b>Getting Started</a><ul><li data-nav-id=/cardano-ogmios/getting-started/docker/ title=Docker class=dd-item><a href=/cardano-ogmios/getting-started/docker/>Docker</a></li><li data-nav-id=/cardano-ogmios/getting-started/building/ title=Building class=dd-item><a href=/cardano-ogmios/getting-started/building/>Building</a></li><li data-nav-id=/cardano-ogmios/getting-started/testing/ title=Testing class=dd-item><a href=/cardano-ogmios/getting-started/testing/>Testing</a></li><li data-nav-id=/cardano-ogmios/getting-started/basics/ title=Basics class=dd-item><a href=/cardano-ogmios/getting-started/basics/>Basics</a></li></ul></li><li data-nav-id=/cardano-ogmios/mini-protocols/ title="Ouroboros Mini-Protocols" class="dd-item
parent"><a href=/cardano-ogmios/mini-protocols/><b>2. </b>Ouroboros Mini-Protocols</a><ul><li data-nav-id=/cardano-ogmios/mini-protocols/local-chain-sync/ title="Local Chain Sync" class="dd-item active"><a href=/cardano-ogmios/mini-protocols/local-chain-sync/>Local Chain Sync</a></li><li data-nav-id=/cardano-ogmios/mini-protocols/local-tx-submission/ title="Local Tx Submission" class=dd-item><a href=/cardano-ogmios/mini-protocols/local-tx-submission/>Local Tx Submission</a></li><li data-nav-id=/cardano-ogmios/mini-protocols/local-state-query/ title="Local State Query" class=dd-item><a href=/cardano-ogmios/mini-protocols/local-state-query/>Local State Query</a></li></ul></li><li data-nav-id=/cardano-ogmios/deployment/ title=Deployment class=dd-item><a href=/cardano-ogmios/deployment/><b>3. </b>Deployment</a><ul><li data-nav-id=/cardano-ogmios/deployment/aws/ title=AWS class=dd-item><a href=/cardano-ogmios/deployment/aws/>AWS</a></li></ul></li><li data-nav-id=/cardano-ogmios/api-reference/ title="API Reference" class=dd-item><a href=/cardano-ogmios/api-reference/><b>4. </b>API Reference</a></li></ul><section id=footer><center><a href=https://github.com/KtorZ/cardano-ogmios><i class="fab fa-github" style=font-size:3em></i></a></center></section></div></nav><section id=body><div id=overlay></div><div class="padding highlightable"><div><div id=top-bar><div id=breadcrumbs itemscope itemtype=http://data-vocabulary.org/Breadcrumb><span id=sidebar-toggle-span><a href=# id=sidebar-toggle data-sidebar-toggle><i class="fas fa-bars"></i></a></span><span id=toc-menu><i class="fas fa-list-alt"></i></span><span class=links><a href=/cardano-ogmios/>Overview</a> > <a href=/cardano-ogmios/mini-protocols/>Ouroboros Mini-Protocols</a> > Local Chain Sync</span></div><div class=progress><div class=wrapper><nav id=TableOfContents><ul><li><a href=#overview>Overview</a></li><li><a href=#how-to-use>How To Use</a></li><li><a href=#requestnext>RequestNext</a></li><li><a href=#findintersect>FindIntersect</a></li><li><a href=#full-example>Full Example</a></li></ul></nav></div></div></div></div><div id=head-tags></div><div id=body-inner><h1>Local Chain Sync</h1><pre style="background:#fff;color:#141414;font-family:courrier new,Courier,monospace;margin:5px;display:inline-block;float:left;border-right:1px dashed #000;margin-right:2em">

*-----------*                                              
| Intersect |◀══════════════════════════════╗              
*-----------*         FindIntersect         ║              
      │                                     ║              
      │                                *---------*         
      │ Intersect.{Found,NotFound}     |         |         
      └───────────────────────────────╼|         |         
                                       |   Idle  |         
   ╔═══════════════════════════════════|         |         
   ║            RequestNext            |         |⇦ START  
   ║                                   *---------*         
   ▼                                        ╿              
*------*       Roll.{Backward,Forward}      │              
| Next |────────────────────────────────────┘              
*------*                                                   

</pre><h2 id=overview>Overview</h2><p>Clients that wish to synchronise blocks from the Cardano chain can use the Local Chain Sync protocol.</p><p>The protocol is stateful, which means that each connection between clients and Ogmios has a state: a cursor locating a point on the chain. Typically, a client will start by looking for an intersection between its own local chain and the one from the node / Ogmios. Then, it&rsquo;ll simply request the next action to take: either rolling forward and adding new blocks, or rolling backward.</p><h2 id=how-to-use>How To Use</h2><p>When you open a connection with Ogmios, you automatically begin a local chain-sync session with the underlying cardano-node; This starts in the <code>Idle</code> state. There&rsquo;s an implicit state maintained by the node which you can imagine as a cursor, pointing to a point on the Cardano chain. Initially, this cursor starts at a special point called: <em>origin</em>. After each request, the node will move the cursor according to the request and remembers its location for the next request. From there, the protocol is in fact quite small and gives you only two choices:</p><ul><li>Ask the node for the &ldquo;next&rdquo; block, where &ldquo;next&rdquo; implicitly refers to point after the cursor.</li><li>Ask the node to set the cursor somewhere else, i.e. find a new intersection.</li></ul><pre><code class=language-none data-lang=none>┌────┬────┬────┬────┬────┬────┬────┬────┬─  
│ 00 │ 01 │ 02 │ 03 │ 04 │ 05 │ 06 │ 07 │ .. Cardano chain
└────┴────┴────┴────┴────┴────┴────┴────┴─  
  ^
  |
origin
</code></pre><h2 id=requestnext>RequestNext</h2><p>To request the next block, send a message with <code>RequestNext</code> as a method name. This request does not accept any argument.</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-json data-lang=json>{ 
    <span style=color:#f92672>&#34;type&#34;</span>: <span style=color:#e6db74>&#34;jsonwsp/request&#34;</span>,
    <span style=color:#f92672>&#34;version&#34;</span>: <span style=color:#e6db74>&#34;1.0&#34;</span>,
    <span style=color:#f92672>&#34;servicename&#34;</span>: <span style=color:#e6db74>&#34;ogmios&#34;</span>,
    <span style=color:#f92672>&#34;methodname&#34;</span>: <span style=color:#e6db74>&#34;RequestNext&#34;</span>,
    <span style=color:#f92672>&#34;args&#34;</span>: {}
}
</code></pre></div><p>As a response, Ogmios will send you back a response which can be either a <code>RollForward</code> or a <code>RollBackward</code>. Rolling forward is pretty straightforward and is the main type of response you can expect; such response will include the next block, which itself includes a header, transactions, certificates, metadata and all sort of information.</p><p>Rolling backward however may occurs when, since your last request, the underlying node decided to switch to a different fork of the chain to the extent that your cursor is longer pointing to a block that exists on this fork. The node therefore asks you (kindly) to roll backward to previously known point, that is the earliest ancestor that is common between your version of the chain and the one that it just adopted.</p><pre><code class=language-none data-lang=none>                              * -- * -- * -- * (node's chain)
                             /
                            *
                           /
* -- * -- * -- * -- * -- * -- * -- * -- * -- * (local chain)
                         ^
                         |
                         |

                  Point of rollback     
</code></pre><p>When rolling backward, the node will not provide a block but instead, a point which is made of a block header hash and a slot.</p><div class="notices info"><p>As a client, it is therefore crucial to be able to rollback to a previous point of the chain. In practice, Ouroboros guarantees that forks cannot be longer than a certain length. This maximum length is called <code>k</code> in the Ouroboros protocol, and also known as <em>the security parameter</em>.</p></div><h2 id=findintersect>FindIntersect</h2><p>On your first connection with the node, you may probably want to synchronize from the <em>origin</em>. Yet, on subsequent connections you may want to resume syncing to a point that is much more recent than the <em>origin</em>. The local chain-sync protocol lets you do that via the <code>FindIntersect</code> message. This message accepts one argument which is a list of header hashes (or the special keyword <code>"origin"</code>). Those header hashes identify blocks that are known by your client that the node will compare with its own chain in order to find a common intersection point.</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-json data-lang=json>{ 
    <span style=color:#f92672>&#34;type&#34;</span>: <span style=color:#e6db74>&#34;jsonwsp/request&#34;</span>,
    <span style=color:#f92672>&#34;version&#34;</span>: <span style=color:#e6db74>&#34;1.0&#34;</span>,
    <span style=color:#f92672>&#34;servicename&#34;</span>: <span style=color:#e6db74>&#34;ogmios&#34;</span>,
    <span style=color:#f92672>&#34;methodname&#34;</span>: <span style=color:#e6db74>&#34;FindIntersect&#34;</span>,
    <span style=color:#f92672>&#34;args&#34;</span>: { 
        <span style=color:#f92672>&#34;points&#34;</span>: [ 
            <span style=color:#e6db74>&#34;9e871633f7aa356ef11cdcabb6fdd6d8f4b00bc919c57aed71a91af8f86df590&#34;</span>,
            <span style=color:#e6db74>&#34;d184f428159290bf3558b4d1d139e6a07ec6589738c28a0925a7ab776bde4d62&#34;</span>,
            <span style=color:#e6db74>&#34;origin&#34;</span> 
        ]
    },
}
</code></pre></div><p>If an intersection is found, great, the node will set the cursor to that point and let you know. If not, the cursor will remain where it was and you&rsquo;ll be be notified. As we&rsquo;ve seen in the previous section, a node may switch to forks based on different strategies. The more points you give, the better. In practice, you may want to give many recent points and a few more that are more sparse and go back at least <code>k</code> blocks in the past (your past).</p><p>For example, imagine the following scenario:</p><pre><code class=language-none data-lang=none>               P01  P02  P03  P04  P05    P98  P99A  P100A
Local chain:    * -- * -- * -- * -- *  ... * -- * -- *  

               P01  P02  P03  P04  P05    P98  P99B  P100B
Node's chain:   * -- * -- * -- * -- *  ... * -- * --  *  
</code></pre><p>As a client, providing any point before or at <code>P98</code> will result in finding an intersection. Yet, if you only provide <code>[P99A, P100A]</code>, the node will not be able to figure out where to continue the protocol and will remain at the <em>origin</em>.</p><div class="notices tip"><p>The order of the list matters! The node will intersect with the best match, considering that your preferred points are first in the list. If you provide <code>origin</code> as a first point, you are guaranteed to always find a match, and always at origin (and that is quite useless!).</p></div><h2 id=full-example>Full Example</h2><p>Let&rsquo;s see a full example that is synchronizing the first 14 blocks of the <strong>Shelley</strong> chain and printing them to the console.</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-js data-lang=js><span style=color:#66d9ef>const</span> <span style=color:#a6e22e>WebSocket</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>require</span>(<span style=color:#e6db74>&#39;ws&#39;</span>);
<span style=color:#66d9ef>const</span> <span style=color:#a6e22e>client</span> <span style=color:#f92672>=</span> <span style=color:#66d9ef>new</span> <span style=color:#a6e22e>WebSocket</span>(<span style=color:#e6db74>&#34;ws://localhost:1337&#34;</span>);

<span style=color:#66d9ef>function</span> <span style=color:#a6e22e>findIntersect</span>(<span style=color:#a6e22e>points</span>) {
    <span style=color:#a6e22e>client</span>.<span style=color:#a6e22e>send</span>(<span style=color:#a6e22e>JSON</span>.<span style=color:#a6e22e>stringify</span>({
        <span style=color:#a6e22e>type</span><span style=color:#f92672>:</span> <span style=color:#e6db74>&#34;jsonwsp/request&#34;</span>,
        <span style=color:#a6e22e>version</span><span style=color:#f92672>:</span> <span style=color:#e6db74>&#34;1.0&#34;</span>,
        <span style=color:#a6e22e>servicename</span><span style=color:#f92672>:</span> <span style=color:#e6db74>&#34;ogmios&#34;</span>,
        <span style=color:#a6e22e>methodname</span><span style=color:#f92672>:</span> <span style=color:#e6db74>&#34;FindIntersect&#34;</span>,
        <span style=color:#a6e22e>args</span><span style=color:#f92672>:</span> { <span style=color:#a6e22e>points</span> }
    }));
}

<span style=color:#66d9ef>function</span> <span style=color:#a6e22e>requestNext</span>(<span style=color:#a6e22e>mirror</span>) {
    <span style=color:#a6e22e>client</span>.<span style=color:#a6e22e>send</span>(<span style=color:#a6e22e>JSON</span>.<span style=color:#a6e22e>stringify</span>({
        <span style=color:#a6e22e>type</span><span style=color:#f92672>:</span> <span style=color:#e6db74>&#34;jsonwsp/request&#34;</span>,
        <span style=color:#a6e22e>version</span><span style=color:#f92672>:</span> <span style=color:#e6db74>&#34;1.0&#34;</span>,
        <span style=color:#a6e22e>servicename</span><span style=color:#f92672>:</span> <span style=color:#e6db74>&#34;ogmios&#34;</span>,
        <span style=color:#a6e22e>methodname</span><span style=color:#f92672>:</span> <span style=color:#e6db74>&#34;RequestNext&#34;</span>,
        <span style=color:#a6e22e>mirror</span>,
    }));
}

<span style=color:#a6e22e>client</span>.<span style=color:#a6e22e>once</span>(<span style=color:#e6db74>&#39;open&#39;</span>, () =&gt; {
    <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>lastByronBlock</span> <span style=color:#f92672>=</span> {
        <span style=color:#a6e22e>slot</span><span style=color:#f92672>:</span> <span style=color:#ae81ff>4492799</span>,
        <span style=color:#a6e22e>hash</span><span style=color:#f92672>:</span> <span style=color:#e6db74>&#34;f8084c61b6a238acec985b59310b6ecec49c0ab8352249afd7268da5cff2a457&#34;</span>
    };
    <span style=color:#a6e22e>findIntersect</span>([<span style=color:#a6e22e>lastByronBlock</span>]);
});

<span style=color:#a6e22e>client</span>.<span style=color:#a6e22e>on</span>(<span style=color:#e6db74>&#39;message&#39;</span>, <span style=color:#66d9ef>function</span>(<span style=color:#a6e22e>msg</span>) {
    <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>response</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>JSON</span>.<span style=color:#a6e22e>parse</span>(<span style=color:#a6e22e>msg</span>);

    <span style=color:#66d9ef>switch</span> (<span style=color:#a6e22e>response</span>.<span style=color:#a6e22e>methodname</span>) {
        <span style=color:#66d9ef>case</span> <span style=color:#e6db74>&#34;FindIntersect&#34;</span><span style=color:#f92672>:</span>
            <span style=color:#66d9ef>if</span> (<span style=color:#f92672>!</span><span style=color:#a6e22e>response</span>.<span style=color:#a6e22e>result</span>.<span style=color:#a6e22e>IntersectionFound</span>) { <span style=color:#66d9ef>throw</span> <span style=color:#e6db74>&#34;Whoops? Last Byron block disappeared?&#34;</span> }
            <span style=color:#a6e22e>requestNext</span>({ <span style=color:#a6e22e>n</span><span style=color:#f92672>:</span> <span style=color:#ae81ff>14</span> });
            <span style=color:#66d9ef>break</span>;


        <span style=color:#66d9ef>case</span> <span style=color:#e6db74>&#34;RequestNext&#34;</span><span style=color:#f92672>:</span>
            <span style=color:#66d9ef>if</span> (<span style=color:#a6e22e>response</span>.<span style=color:#a6e22e>result</span>.<span style=color:#a6e22e>RollForward</span>) {
                <span style=color:#a6e22e>console</span>.<span style=color:#a6e22e>log</span>(<span style=color:#a6e22e>response</span>.<span style=color:#a6e22e>result</span>);
            }

            <span style=color:#66d9ef>if</span> (<span style=color:#a6e22e>response</span>.<span style=color:#a6e22e>reflection</span>.<span style=color:#a6e22e>n</span> <span style=color:#f92672>&gt;</span> <span style=color:#ae81ff>0</span>) {
                <span style=color:#a6e22e>requestNext</span>({ <span style=color:#a6e22e>n</span><span style=color:#f92672>:</span> <span style=color:#a6e22e>response</span>.<span style=color:#a6e22e>reflection</span>.<span style=color:#a6e22e>n</span> <span style=color:#f92672>-</span> <span style=color:#ae81ff>1</span> });
            } <span style=color:#66d9ef>else</span> {
                <span style=color:#a6e22e>client</span>.<span style=color:#a6e22e>close</span>();
            }
            <span style=color:#66d9ef>break</span>;
    }
});
</code></pre></div><p>A few important takes from this excerpt:</p><ul><li><p>The node continues to stream blocks from intersection point. So if we want the first 14 Shelley blocks, we need to set the intersection at the last Byron block!</p></li><li><p>After successfully finding an intersection, the node will <strong>always</strong> ask us to roll backward to that intersection point. This is because it is possible to provide many points when looking for intersection and the protocol makes sure that both the node and the client are in sync.</p></li><li><p>In this schema, we are sending each request one-by-one, using the <code>mirror</code> field as counter. An alternative could have been:</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-js data-lang=js><span style=color:#66d9ef>case</span> <span style=color:#e6db74>&#34;FindIntersect&#34;</span><span style=color:#f92672>:</span>
    <span style=color:#66d9ef>if</span> (<span style=color:#f92672>!</span><span style=color:#a6e22e>response</span>.<span style=color:#a6e22e>result</span>.<span style=color:#a6e22e>IntersectionFound</span>) { <span style=color:#66d9ef>throw</span> <span style=color:#e6db74>&#34;Whoops? First Shelley block disappeared?&#34;</span> }
    <span style=color:#66d9ef>for</span> (<span style=color:#66d9ef>let</span> <span style=color:#a6e22e>i</span> <span style=color:#f92672>=</span> <span style=color:#ae81ff>14</span>; <span style=color:#a6e22e>i</span> <span style=color:#f92672>&gt;</span> <span style=color:#ae81ff>0</span>; <span style=color:#a6e22e>i</span> <span style=color:#f92672>+=</span> <span style=color:#ae81ff>1</span>) {
        <span style=color:#a6e22e>requestNext</span>()
    }
    <span style=color:#66d9ef>break</span>;
</code></pre></div><p>We need not to wait for replies to send requests and can collect all responses at a later stage.</p></li></ul><footer class=footline></footer></div></div><div id=navigation><a class="nav nav-prev" href=/cardano-ogmios/mini-protocols/ title="Ouroboros Mini-Protocols"><i class="fa fa-chevron-left"></i></a><a class="nav nav-next" href=/cardano-ogmios/mini-protocols/local-tx-submission/ title="Local Tx Submission" style=margin-right:0><i class="fa fa-chevron-right"></i></a></div></section><div style=left:-1000px;overflow:scroll;position:absolute;top:-1000px;border:none;box-sizing:content-box;height:200px;margin:0;padding:0;width:200px><div style=border:none;box-sizing:content-box;height:200px;margin:0;padding:0;width:200px></div></div><script src=/cardano-ogmios/js/clipboard.min.js?1603821225></script><script src=/cardano-ogmios/js/perfect-scrollbar.min.js?1603821225></script><script src=/cardano-ogmios/js/perfect-scrollbar.jquery.min.js?1603821225></script><script src=/cardano-ogmios/js/jquery.sticky.js?1603821225></script><script src=/cardano-ogmios/js/featherlight.min.js?1603821225></script><script src=/cardano-ogmios/js/highlight.pack.js?1603821225></script><script>hljs.initHighlightingOnLoad();</script><script src=/cardano-ogmios/js/modernizr.custom-3.6.0.js?1603821225></script><script src=/cardano-ogmios/js/learn.js?1603821225></script><script src=/cardano-ogmios/js/hugo-learn.js?1603821225></script></body></html>