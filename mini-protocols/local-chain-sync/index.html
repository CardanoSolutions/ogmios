<!doctype html><html lang=en class="js csstransforms3d"><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta name=generator content="Hugo 0.76.5"><meta name=description content="User manual for Ogmios, a lightweight protocol translation service for Cardano."><meta name=author content="KtorZ <matthias.benkort@gmail.com>"><link rel=icon href=/images/favicon.png type=image/png><title>Chain synchronization - Ogmios</title><link href=/css/nucleus.css?1691087856 rel=stylesheet><link href=/css/fontawesome-all.min.css?1691087856 rel=stylesheet><link href=/css/hybrid.css?1691087856 rel=stylesheet><link href=/css/featherlight.min.css?1691087856 rel=stylesheet><link href=/css/perfect-scrollbar.min.css?1691087856 rel=stylesheet><link href=/css/auto-complete.css?1691087856 rel=stylesheet><link href=/css/atom-one-dark-reasonable.css?1691087856 rel=stylesheet><link href=/css/theme.css?1691087856 rel=stylesheet><link href=/css/tabs.css?1691087856 rel=stylesheet><link href=/css/hugo-theme.css?1691087856 rel=stylesheet><link href=/css/theme-mine.css?1691087856 rel=stylesheet><script src=/js/jquery-3.3.1.min.js?1691087856></script><style>:root #header+#content>#left>#rlblock_left{display:none!important}</style></head><body data-url=/mini-protocols/local-chain-sync/><nav id=sidebar><div id=header-wrapper><div id=header><a href=/><img alt=ogmios src=/ogmios__light.png></a></div><div class=searchbox><label for=search-by><i class="fas fa-search"></i></label><input data-search-input id=search-by type=search placeholder=Search...>
<span data-search-clear><i class="fas fa-times"></i></span></div><script type=text/javascript src=/js/lunr.min.js?1691087856></script><script type=text/javascript src=/js/auto-complete.js?1691087856></script><script type=text/javascript>var baseurl="https:\/\/ogmios.dev";</script><script type=text/javascript src=/js/search.js?1691087856></script></div><div class=highlightable><ul class=topics><li data-nav-id=/getting-started/ title="Getting started" class=dd-item><a href=/getting-started/><b>1. </b>Getting started</a><ul><li data-nav-id=/getting-started/docker/ title=Docker class=dd-item><a href=/getting-started/docker/>Docker</a></li><li data-nav-id=/getting-started/building/ title=Building class=dd-item><a href=/getting-started/building/>Building</a></li><li data-nav-id=/getting-started/testing/ title=Testing class=dd-item><a href=/getting-started/testing/>Testing</a></li><li data-nav-id=/getting-started/monitoring/ title=Monitoring class=dd-item><a href=/getting-started/monitoring/>Monitoring</a></li><li data-nav-id=/getting-started/basics/ title=Basics class=dd-item><a href=/getting-started/basics/>Basics</a></li></ul></li><li data-nav-id=/mini-protocols/ title=Mini-Protocols class="dd-item
parent"><a href=/mini-protocols/><b>2. </b>Mini-Protocols</a><ul><li data-nav-id=/mini-protocols/local-chain-sync/ title="Chain synchronization" class="dd-item active"><a href=/mini-protocols/local-chain-sync/>Chain synchronization</a></li><li data-nav-id=/mini-protocols/local-state-query/ title="Ledger state queries" class=dd-item><a href=/mini-protocols/local-state-query/>Ledger state queries</a></li><li data-nav-id=/mini-protocols/local-tx-submission/ title="Transaction submission" class=dd-item><a href=/mini-protocols/local-tx-submission/>Transaction submission</a></li><li data-nav-id=/mini-protocols/local-tx-monitor/ title="Mempool monitoring" class=dd-item><a href=/mini-protocols/local-tx-monitor/>Mempool monitoring</a></li></ul></li><li data-nav-id=/clients/ title=Clients class=dd-item><a href=/clients/><b>3. </b>Clients</a></li><li data-nav-id=/api/ title="API Reference" class=dd-item><a href=/api/><b>4. </b>API Reference</a></li><li data-nav-id=/changelog/ title=Changelog class=dd-item><a href=/changelog/><b>5. </b>Changelog</a></li><li data-nav-id=/faq/ title=F.A.Q class=dd-item><a href=/faq/><b>6. </b>F.A.Q</a></li></ul><section id=shortcuts><h3>More</h3><ul><li><a class=padding href=https://github.com/cardanosolutions/ogmios><i class="fab fa-github"></i>Source code</a></li><li><a class=padding href=https://github.com/cardanosolutions/ogmios/issues><i class="fas fa-solid fa-bullseye"></i>Issues Tracking</a></li><li><a class=padding href=https://discord.gg/ZeyDn65t5v><i class="fab fa-discord"></i>Discord (#ogmios)</a></li><li><a class=padding href=https://github.com/CardanoSolutions/ogmios/tree/master/architectural-decisions/accepted><i class="fas fa-solid fa-file-code"></i>Architectural Decisions Record</a></li></ul></section><section id=footer><p>Built with <a href=https://github.com/matcornic/hugo-theme-learn><i class="fas fa-heart"></i></a>from <a href=https://getgrav.org>Grav</a> and <a href=https://gohugo.io/>Hugo</a></p></section></div></nav><section id=body><div id=overlay></div><div class="padding highlightable"><div><div id=top-bar><div id=breadcrumbs itemscope itemtype=http://data-vocabulary.org/Breadcrumb><span id=sidebar-toggle-span><a href=# id=sidebar-toggle data-sidebar-toggle><i class="fas fa-bars"></i></a></span><span id=toc-menu><i class="fas fa-list-alt"></i></span><span class=links><a href=/>Overview</a> > <a href=/mini-protocols/>Mini-Protocols</a> > Chain synchronization</span></div><div class=progress><div class=wrapper><nav id=TableOfContents><ul><li><a href=#overview>Overview</a></li><li><a href=#how-to-use>How To Use</a></li><li><a href=#requesting-next-blocks>Requesting next blocks</a><ul><li><a href=#pipelining>Pipelining</a></li></ul></li><li><a href=#finding-an-intersection>Finding an intersection</a><ul><li><a href=#points-of-interest>Points of interest</a></li></ul></li><li><a href=#full-example>Full example</a></li><li><a href=#errors>Errors</a></li><li><a href=#api-reference>API Reference</a></li></ul></nav></div></div></div></div><div id=head-tags></div><div id=body-inner><h1>Chain synchronization</h1><div class="ascii-drawing ascii-drawing-split"><pre style=font-family:monospace> 
              START
                ⇓
        ┌───────────────┐
        │     Idle      │⇒ DONE
        └───────┬───────┘
                │
                │ findIntersection
                │
                │
                │      findIntersection
                │   ╭───────╮
                ▼   │       │
        ┌───────────┴───┐   │
        │  Initialized  │◀──╯
        └───┬───────────┘
            │       ▲
 nextBlock  │       │
            ╰───────╯
 </pre></div><h2 id=overview>Overview</h2><p>Clients that wish to synchronise blocks from the Cardano chain can use the chain synchronization mini-protocol.</p><p>The protocol is stateful, which means that each connection between clients and Ogmios has a state: a cursor locating a point on the chain. Typically, a client will start by looking for an intersection between its own local chain and the one from the node / Ogmios. Then, it&rsquo;ll simply request the next action to take: either rolling forward and adding new blocks, or rolling backward.</p><h2 id=how-to-use>How To Use</h2><p>When a connection is opened with Ogmios, it automatically starts a chain synchronization session with the underlying cardano-node. There&rsquo;s an implicit state maintained by the node which one can imagine as a cursor, pointing to a point on the Cardano chain. Initially, this cursor starts at a special point called: <em>origin</em> (as in, the origin of the chain). After each request, the node will move the cursor either forward or backward and remembers its location for the next request. To move the cursor, the protocols gives two mechanisms: <code>nextBlock</code> and <code>findIntersection</code>.</p><div class=ascii-drawing><pre style=font-family:monospace> 
        ____          ____          ____          ____          ____          ____
       /    /\       /    /\       /    /\       /    /\       /    /\       /    /\
o === /____/  \ === /____/  \ === /____/  \ === /____/  \ === /____/  \ === /____/  \ == ...
      \    \  /     \    \  /     \    \  /     \    \  /     \    \  /     \    \  /
       \____\/       \____\/       \____\/       \____\/       \____\/       \____\/
^
|
|
<p>origin
</pre></p></div><h2 id=requesting-next-blocks>Requesting next blocks</h2><p>Clients may ask for the next block where &lsquo;next&rsquo; refers directly to that implicit cursor. This translates to a message with <code>nextBlock</code> as a method name. This request does not accept any arguments (i.e. `params).</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-json data-lang=json>{
    <span style=color:#f92672>&#34;jsonrpc&#34;</span>: <span style=color:#e6db74>&#34;2.0&#34;</span>,
    <span style=color:#f92672>&#34;method&#34;</span>: <span style=color:#e6db74>&#34;nextBlock&#34;</span>
}
</code></pre></div><p>As a response, Ogmios will send back a response which can instruct you either to <em>roll forward</em> or to <em>roll backward</em>. Rolling forward is pretty straightforward and is the main type of response one can expect; such response will include the next block, which itself includes a header, transactions, certificates, metadata and all sort of information.</p><p>Rolling backward however may occur when, since the last request, the underlying node decided to switch to a different fork of the chain to the extent that the previous cursor is no longer pointing to a block that exists on the chain. The node therefore asks (kindly) to roll backward to a previously known point that is the earliest ancestor that is common between the client&rsquo;s own chain locally and the one that was just adopted by the node.</p><div class=ascii-drawing><pre style=font-family:monospace> 
                                      ____          ____
                                     /    /\       /    /\
                                    /____/  \ === /____/  \  (node's chain)
                                    \    \  /     \    \  /
                                 /   \____\/       \____\/
                                /
      ____          ____       /   ____          ____
     /    /\       /    /\    /  /    /\       /    /\
=== /____/  \ === /____/  \ =.= /____/  \ === /____/  \  (local chain)
    \    \  /     \    \  /  ^  \    \  /     \    \  /
     \____\/       \____\/   |   \____\/       \____\/
                             |
<------------------------->  |
    common chain prefix      |
                             |
                     point of rollback
 </pre></div><p>When rolling backward, the node will not provide a block but instead, a point which is made of a block header hash and a slot.</p><div class="notices info"><p>As a client, it is therefore crucial to be able to rollback to a previous point of the chain. In practice, Ouroboros guarantees that forks cannot be longer than a certain length. This maximum length is called <code>k</code> in the Ouroboros protocol, and also known as <em>the security parameter</em>.</p></div><h3 id=pipelining>Pipelining</h3><p>Ogmios will do its best to <a href=https://en.wikipedia.org/wiki/HTTP_pipelining>pipeline</a> requests to the Cardano node. Yet unlike WebSocket, the chain synchronization protocol only allows for finite pipelining. Said differently, Ogmios cannot pipeline an arbitrary and potentially infinite number of requests and will actually starts collecting responses if too many requests are pipelined. Pipelining with WebSocket is however straightforward for most clients permit sending many requests at once and handle responses using callbacks on event handlers.</p><p><img src=/pipelining.png alt></p><p>To leverage pipelining using the WebSocket, you will need send multiple requests at once and have your client handler send new requests for each response. Behind the scene, the server will translate that to explicit pipelining with the cardano-node and maximize the bandwith utilization. Note that you also probably want to send requests for the next message before you even start processing the last received message. This permits the server to start working on fetching and sending you the next result while you process the current one.</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-js data-lang=js><span style=color:#66d9ef>const</span> <span style=color:#a6e22e>nextBlock</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>JSON</span>.<span style=color:#a6e22e>stringify</span>({
  <span style=color:#e6db74>&#34;jsonrpc&#34;</span><span style=color:#f92672>:</span> <span style=color:#e6db74>&#34;2.0&#34;</span>,
  <span style=color:#e6db74>&#34;method&#34;</span><span style=color:#f92672>:</span> <span style=color:#e6db74>&#34;nextBlock&#34;</span>,
});

<span style=color:#a6e22e>client</span>.<span style=color:#a6e22e>on</span>(<span style=color:#e6db74>&#39;open&#39;</span>, () =&gt; {
  <span style=color:#75715e>// Burst the server&#39;s queue with a few requests.
</span><span style=color:#75715e></span>  <span style=color:#66d9ef>for</span> (<span style=color:#66d9ef>let</span> <span style=color:#a6e22e>i</span> <span style=color:#f92672>=</span> <span style=color:#ae81ff>0</span>; <span style=color:#a6e22e>i</span> <span style=color:#f92672>&lt;</span> <span style=color:#ae81ff>100</span>; <span style=color:#a6e22e>i</span> <span style=color:#f92672>+=</span> <span style=color:#ae81ff>1</span>) {
    <span style=color:#a6e22e>client</span>.<span style=color:#a6e22e>send</span>(<span style=color:#a6e22e>nextBlock</span>);
  }
});

<span style=color:#a6e22e>client</span>.<span style=color:#a6e22e>on</span>(<span style=color:#e6db74>&#39;message&#39;</span>, <span style=color:#a6e22e>msg</span> =&gt; {
  <span style=color:#a6e22e>client</span>.<span style=color:#a6e22e>send</span>(<span style=color:#a6e22e>nextBlock</span>); <span style=color:#75715e>// Ask for next request immediately
</span><span style=color:#75715e></span>  <span style=color:#a6e22e>doSomething</span>(<span style=color:#a6e22e>msg</span>);
})
</code></pre></div><div class="notices warning"><p>How many requests to pipeline depends on your application and machine resources. If you&rsquo;re pipelining many requests in a client application, make sure to also take times to collect and handle responses because there will be no extra benefits coming from <em>too much pipelining</em>. A good rule of thumb on most standard machines is to pipeline <strong>50-100 requests</strong>.</p></div><h2 id=finding-an-intersection>Finding an intersection</h2><p>On the first connection with the node, clients will likely synchronize from the <em>origin</em>. Yet, on subsequent connections one may want to resume syncing to a point that is much more recent than the <em>origin</em>. Ideally, one would like to carry on exactly at the point where the chain was left yet as we just saw, this is not always possible. The chain synchronization protocol gives however clients a way to find a common intersection between a client&rsquo;s current version of the chain and whatever version the node has. This is via the <code>findIntersection</code> method. This method accepts one argument which is a list of header hashes (or the special keyword <code>"origin"</code>).</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-json data-lang=json>{
    <span style=color:#f92672>&#34;jsonrpc&#34;</span>: <span style=color:#e6db74>&#34;2.0&#34;</span>,
    <span style=color:#f92672>&#34;method&#34;</span>: <span style=color:#e6db74>&#34;findIntersection&#34;</span>,
    <span style=color:#f92672>&#34;params&#34;</span>: {
        <span style=color:#f92672>&#34;points&#34;</span>: [
            {
              <span style=color:#f92672>&#34;slot&#34;</span>: <span style=color:#ae81ff>39916796</span>,
              <span style=color:#f92672>&#34;hash&#34;</span>: <span style=color:#e6db74>&#34;e72579ff89dc9ed325b723a33624b596c08141c7bd573ecfff56a1f7229e4d09&#34;</span>
            },
            {
              <span style=color:#f92672>&#34;slot&#34;</span>: <span style=color:#ae81ff>23068793</span>,
              <span style=color:#f92672>&#34;hash&#34;</span>: <span style=color:#e6db74>&#34;69c44ac1dda2ec74646e4223bc804d9126f719b1c245dadc2ad65e8de1b276d7&#34;</span>
            },
            <span style=color:#e6db74>&#34;origin&#34;</span>
        ]
    }
}
</code></pre></div><p>If an intersection is found, great, the node will set the cursor to that point and let you know. If not, the cursor will remain where it was and the failure will also be broadcast. As we&rsquo;ve seen in the previous section, a node may switch to longer forks based quite arbitrarily. Hence, a good list of intersections candidates is preferably dense near the tip of the chain, and goes far back in the past (<code>k</code> is typically not enough).</p><p>For example, imagine the following scenario:</p><ul><li>Local chain: <code>[P01,P02,P03,..,P98,P99A,P100A]</code></li><li>Node&rsquo;s chain: <code>[P01,P02,P03,..,P98,P99B,P100B]</code></li></ul><p>As a client, providing any point before or at <code>P98</code> will result in finding an intersection. Yet, if one only provides <code>[P99A, P100A]</code>, the node will not be able to figure out where to continue the protocol and will remain at the <em>origin</em>.</p><div class="notices tip"><p>The order of the list matters! The node will intersect with the best match, considering that the preferred points are first in the list. If one provides <code>origin</code> as a first point, an intersection is guaranteed to always find a match, and always at origin (and that is quite useless!).</p></div><h3 id=points-of-interest>Points of interest</h3><p>For several applications, it may be quite useful to know the last point of each era; This allows to start syncing blocks from the beginning of a particular era. For instance, after seeking an intersection with the last point of the Shelley, <code>nextBlock</code> would yield the first block of the Allegra era. Handy!</p><div class=tab-panel><div class=tab-nav><button data-tab-item=Mainnet data-tab-group=default class="tab-nav-button btn active" onclick="switchTab('default','Mainnet')">Mainnet</button>
<button data-tab-item=Preview data-tab-group=default class="tab-nav-button btn" onclick="switchTab('default','Preview')">Preview</button>
<button data-tab-item=Preprod data-tab-group=default class="tab-nav-button btn" onclick="switchTab('default','Preprod')">Preprod</button></div><div class=tab-content><div data-tab-item=Mainnet data-tab-group=default class="tab-item active"><table><thead><tr><th>Era Bound</th><th>Block Number</th><th>Absolute Slot Number</th><th>Block Header Hash</th></tr></thead><tbody><tr><td>Last <i>Byron</i> block</td><td><small><a target=_blank href=https://cardanoscan.io/block/4490510>4490510 <i style=font-size:.8rem class="fas fa-external-link-alt"></i></a></small></td><td><small><code>4492799</code></small></td><td><small><code>f8084c61b6a238acec985b59310b6ecec49c0ab8352249afd7268da5cff2a457</code></small></td></tr><tr><td>Last <i>Shelley</i> block</td><td><small><a target=_blank href=https://cardanoscan.io/block/5086523>5086523 <i style=font-size:.8rem class="fas fa-external-link-alt"></i></a></small></td><td><small><code>16588737</code></small></td><td><small><code>4e9bbbb67e3ae262133d94c3da5bffce7b1127fc436e7433b87668dba34c354a</code></small></td></tr><tr><td>Last <i>Allegra</i> block</td><td><small><a target=_blank href=https://cardanoscan.io/block/5406746>5406746 <i style=font-size:.8rem class="fas fa-external-link-alt"></i></a></small></td><td><small><code>23068793</code></small></td><td><small><code>69c44ac1dda2ec74646e4223bc804d9126f719b1c245dadc2ad65e8de1b276d7</code></small></td></tr><tr><td>Last <i>Mary</i> block</td><td><small><a target=_blank href=https://cardanoscan.io/block/6236059>6236059 <i style=font-size:.8rem class="fas fa-external-link-alt"></i></a></small></td><td><small><code>39916796</code></small></td><td><small><code>e72579ff89dc9ed325b723a33624b596c08141c7bd573ecfff56a1f7229e4d09</code></small></td></tr><tr><td>Last <i>Alonzo</i> block</td><td><small><a target=_blank href=https://cardanoscan.io/block/7791698>7791698 <i style=font-size:.8rem class="fas fa-external-link-alt"></i></a></small></td><td><small><code>72316796</code></small></td><td><small><code>c58a24ba8203e7629422a24d9dc68ce2ed495420bf40d9dab124373655161a20</code></small></td></tr><tr><td>Last <i>Babbage</i> block</td><td>N/A</td><td><small><code>N/A</code></small></td><td><small><code>N/A</code></small></td></tr></tbody></table></div><div data-tab-item=Preview data-tab-group=default class=tab-item><table><thead><tr><th>Era Bound</th><th>Block Number</th><th>Absolute Slot Number</th><th>Block Header Hash</th></tr></thead><tbody><tr><td>Last <i>Byron</i> block</td><td>N/A</td><td><small><code>N/A</code></small></td><td><small><code>N/A</code></small></td></tr><tr><td>Last <i>Shelley</i> block</td><td>N/A</td><td><small><code>N/A</code></small></td><td><small><code>N/A</code></small></td></tr><tr><td>Last <i>Allegra</i> block</td><td>N/A</td><td><small><code>N/A</code></small></td><td><small><code>N/A</code></small></td></tr><tr><td>Last <i>Mary</i> block</td><td>N/A</td><td><small><code>N/A</code></small></td><td><small><code>N/A</code></small></td></tr><tr><td>Last <i>Alonzo</i> block</td><td><small><a target=_blank href=https://preview.cardanoscan.io/block/13011>13011 <i style=font-size:.8rem class="fas fa-external-link-alt"></i></a></small></td><td><small><code>259180</code></small></td><td><small><code>0ad91d3bbe350b1cfa05b13dba5263c47c5eca4f97b3a3105eba96416785a487</code></small></td></tr><tr><td>Last <i>Babbage</i> block</td><td>N/A</td><td><small><code>N/A</code></small></td><td><small><code>N/A</code></small></td></tr></tbody></table></div><div data-tab-item=Preprod data-tab-group=default class=tab-item><table><thead><tr><th>Era Bound</th><th>Block Number</th><th>Absolute Slot Number</th><th>Block Header Hash</th></tr></thead><tbody><tr><td>Last <i>Byron</i> block</td><td><small><a target=_blank href=https://preprod.cardanoscan.io/block/45>45 <i style=font-size:.8rem class="fas fa-external-link-alt"></i></a></small></td><td><small><code>84242</code></small></td><td><small><code>45899e8002b27df291e09188bfe3aeb5397ac03546a7d0ead93aa2500860f1af</code></small></td></tr><tr><td>Last <i>Shelley</i> block</td><td><small><a target=_blank href=https://preprod.cardanoscan.io/block/21644>21644 <i style=font-size:.8rem class="fas fa-external-link-alt"></i></a></small></td><td><small><code>518360</code></small></td><td><small><code>f9d8b6c77fedd60c3caf5de0ce63a0aeb9d1753269c9c07503d9aa09d5144481</code></small></td></tr><tr><td>Last <i>Allegra</i> block</td><td><small><a target=_blank href=https://preprod.cardanoscan.io/block/43242>43242 <i style=font-size:.8rem class="fas fa-external-link-alt"></i></a></small></td><td><small><code>950340</code></small></td><td><small><code>74c03af754bcde9cd242c5a168689edcab1756a3f7ae4d5dca1a31d86839c7b1</code></small></td></tr><tr><td>Last <i>Mary</i> block</td><td><small><a target=_blank href=https://preprod.cardanoscan.io/block/64902>64902 <i style=font-size:.8rem class="fas fa-external-link-alt"></i></a></small></td><td><small><code>1382348</code></small></td><td><small><code>af5fddc7d16a349e1a2af8ba89f4f5d3273955a13095b3709ef6e3db576a0b33</code></small></td></tr><tr><td>Last <i>Alonzo</i> block</td><td><small><a target=_blank href=https://preprod.cardanoscan.io/block/172497>172497 <i style=font-size:.8rem class="fas fa-external-link-alt"></i></a></small></td><td><small><code>3542390</code></small></td><td><small><code>f93e682d5b91a94d8660e748aef229c19cb285bfb9830db48941d6a78183d81f</code></small></td></tr><tr><td>Last <i>Babbage</i> block</td><td>N/A</td><td><small><code>N/A</code></small></td><td><small><code>N/A</code></small></td></tr></tbody></table></div></div></div><div class="notices tip"><p>Remember also that <code>"origin"</code> is a special point whichs refers to the beginning of the blockchain; An intersection with <code>"origin"</code> will <strong>always</strong> be found.</p></div><h2 id=full-example>Full example</h2><p>Let&rsquo;s see a full example that is synchronizing the first 14 blocks of the <strong>Shelley</strong> chain and printing them to the console.</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-js data-lang=js><span style=color:#66d9ef>const</span> <span style=color:#a6e22e>WebSocket</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>require</span>(<span style=color:#e6db74>&#39;ws&#39;</span>);
<span style=color:#66d9ef>const</span> <span style=color:#a6e22e>client</span> <span style=color:#f92672>=</span> <span style=color:#66d9ef>new</span> <span style=color:#a6e22e>WebSocket</span>(<span style=color:#e6db74>&#34;ws://localhost:1337&#34;</span>);

<span style=color:#66d9ef>function</span> <span style=color:#a6e22e>rpc</span>(<span style=color:#a6e22e>method</span>, <span style=color:#a6e22e>params</span>, <span style=color:#a6e22e>id</span>) {
    <span style=color:#a6e22e>client</span>.<span style=color:#a6e22e>send</span>(<span style=color:#a6e22e>JSON</span>.<span style=color:#a6e22e>stringify</span>({
        <span style=color:#a6e22e>jsonrpc</span><span style=color:#f92672>:</span> <span style=color:#e6db74>&#34;2.0&#34;</span>,
        <span style=color:#a6e22e>method</span>,
        <span style=color:#a6e22e>params</span>,
        <span style=color:#a6e22e>id</span>
    }));
}

<span style=color:#a6e22e>client</span>.<span style=color:#a6e22e>once</span>(<span style=color:#e6db74>&#39;open&#39;</span>, () =&gt; {
    <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>lastByronBlock</span> <span style=color:#f92672>=</span> {
        <span style=color:#a6e22e>slot</span><span style=color:#f92672>:</span> <span style=color:#ae81ff>4492799</span>,
        <span style=color:#a6e22e>hash</span><span style=color:#f92672>:</span> <span style=color:#e6db74>&#34;f8084c61b6a238acec985b59310b6ecec49c0ab8352249afd7268da5cff2a457&#34;</span>
    };
    <span style=color:#a6e22e>rpc</span>(<span style=color:#e6db74>&#34;findIntersection&#34;</span>, { <span style=color:#a6e22e>points</span><span style=color:#f92672>:</span> [<span style=color:#a6e22e>lastByronBlock</span>] }, <span style=color:#e6db74>&#34;find-intersection&#34;</span>);
});

<span style=color:#a6e22e>client</span>.<span style=color:#a6e22e>on</span>(<span style=color:#e6db74>&#39;message&#39;</span>, <span style=color:#66d9ef>function</span>(<span style=color:#a6e22e>msg</span>) {
    <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>response</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>JSON</span>.<span style=color:#a6e22e>parse</span>(<span style=color:#a6e22e>msg</span>);

    <span style=color:#66d9ef>switch</span> (<span style=color:#a6e22e>response</span>.<span style=color:#a6e22e>id</span>) {
        <span style=color:#66d9ef>case</span> <span style=color:#e6db74>&#34;find-intersection&#34;</span><span style=color:#f92672>:</span>
            <span style=color:#66d9ef>if</span> (<span style=color:#f92672>!</span><span style=color:#a6e22e>response</span>.<span style=color:#a6e22e>result</span>.<span style=color:#a6e22e>intersection</span>) { <span style=color:#66d9ef>throw</span> <span style=color:#e6db74>&#34;Whoops? Last Byron block disappeared?&#34;</span> }
            <span style=color:#a6e22e>rpc</span>(<span style=color:#e6db74>&#34;nextBlock&#34;</span>, {}, <span style=color:#ae81ff>14</span>);
            <span style=color:#66d9ef>break</span>;

        <span style=color:#66d9ef>default</span><span style=color:#f92672>:</span>
            <span style=color:#66d9ef>if</span> (<span style=color:#a6e22e>response</span>.<span style=color:#a6e22e>result</span>.<span style=color:#a6e22e>direction</span> <span style=color:#f92672>===</span> <span style=color:#e6db74>&#34;forward&#34;</span>) {
                <span style=color:#a6e22e>console</span>.<span style=color:#a6e22e>log</span>(<span style=color:#a6e22e>response</span>.<span style=color:#a6e22e>result</span>);
            }

            <span style=color:#66d9ef>if</span> (<span style=color:#a6e22e>response</span>.<span style=color:#a6e22e>id</span> <span style=color:#f92672>&gt;</span> <span style=color:#ae81ff>0</span>) {
                <span style=color:#a6e22e>rpc</span>(<span style=color:#e6db74>&#34;nextBlock&#34;</span>, {}, <span style=color:#a6e22e>response</span>.<span style=color:#a6e22e>id</span> <span style=color:#f92672>-</span> <span style=color:#ae81ff>1</span>);
            } <span style=color:#66d9ef>else</span> {
                <span style=color:#a6e22e>client</span>.<span style=color:#a6e22e>close</span>();
            }
            <span style=color:#66d9ef>break</span>;
    }
});
</code></pre></div><p>A few important takes from this excerpt:</p><ul><li><p>The node streams blocks that are <strong>after</strong> the intersection point. Thus to get the first 14 Shelley blocks, one needs to set the intersection at the last Byron block!</p></li><li><p>After successfully finding an intersection, the node will <strong>always</strong> ask to roll backward to that intersection point. This is because it is possible to provide many points when looking for an intersection and the protocol makes sure that both the node and the client are in sync. This allows clients applications to be somewhat &ldquo;dumb&rdquo; and blindly follow instructions from the node.</p></li><li><p>In this schema, we are sending each request one-by-one, using the <code>id</code> field as counter. An alternative could have been:</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-js data-lang=js><span style=color:#66d9ef>switch</span> (<span style=color:#a6e22e>response</span>.<span style=color:#a6e22e>id</span>) {
  <span style=color:#66d9ef>case</span> <span style=color:#e6db74>&#34;find-intersection&#34;</span><span style=color:#f92672>:</span>
      <span style=color:#66d9ef>if</span> (<span style=color:#f92672>!</span><span style=color:#a6e22e>response</span>.<span style=color:#a6e22e>result</span>.<span style=color:#a6e22e>intersection</span>) { <span style=color:#66d9ef>throw</span> <span style=color:#e6db74>&#34;Whoops? Last Byron block disappeared?&#34;</span> }
      <span style=color:#66d9ef>for</span> (<span style=color:#66d9ef>let</span> <span style=color:#a6e22e>i</span> <span style=color:#f92672>=</span> <span style=color:#ae81ff>14</span>; <span style=color:#a6e22e>i</span> <span style=color:#f92672>&gt;</span> <span style=color:#ae81ff>0</span>; <span style=color:#a6e22e>i</span> <span style=color:#f92672>+=</span> <span style=color:#ae81ff>1</span>) {
          <span style=color:#a6e22e>rpc</span>(<span style=color:#e6db74>&#34;nextBlock&#34;</span>);
      }
      <span style=color:#66d9ef>break</span>;

  ...
}
</code></pre></div><p>We need not to wait for replies to send requests and can collect all responses at a later stage!</p></li></ul><h2 id=errors>Errors</h2><p>Errors from the chain synchronization protocol are in the range <code>1000-1999</code> and are listed below.</p><style>#asyncapi #introduction,#asyncapi #schemas>h2{display:none}#asyncapi .panel-item--center.px-8,#asyncapi .aui-root .py-8,#asyncapi .aui-root .mt-16{padding:0;margin:0}</style><div id=asyncapi></div><link rel=stylesheet href=https://unpkg.com/@asyncapi/react-component@1.0.0-next.47/styles/default.min.css><script src=https://unpkg.com/@asyncapi/react-component@1.0.0-next.47/browser/standalone/index.js></script><script>AsyncApiStandalone.render({config:{show:{messages:false},},schema:"\nasyncapi: '2.4.0'\ninfo:\n  title: \"\"\n  version: '6.0.0'\nservers: {}\nchannels: {}\ncomponents:\n  schemas:\n    1000:\n      $ref: \"/ogmios.json#/properties/FindIntersectionResponse/oneOf/1/properties/error\"\n    1001:\n      $ref: \"/ogmios.json#/properties/FindIntersectionResponse/oneOf/2/properties/error\"\n",},document.getElementById('asyncapi'));</script><h2 id=api-reference>API Reference</h2><p>The complete description of the mempool monitoring requests and responses can be found in the <a href=../../api>API reference</a>.</p><p>Plus, <a href=https://github.com/CardanoSolutions/ogmios/tree/master/server/test/vectors>test vectors</a> are available on the repository for testing, debugging and to serve as examples.</p><footer class=footline></footer></div></div><div id=navigation><a class="nav nav-prev" href=/mini-protocols/ title=Mini-Protocols><i class="fa fa-chevron-left"></i></a><a class="nav nav-next" href=/mini-protocols/local-state-query/ title="Ledger state queries" style=margin-right:0><i class="fa fa-chevron-right"></i></a></div></section><div style=left:-1000px;overflow:scroll;position:absolute;top:-1000px;border:none;box-sizing:content-box;height:200px;margin:0;padding:0;width:200px><div style=border:none;box-sizing:content-box;height:200px;margin:0;padding:0;width:200px></div></div><script src=/js/clipboard.min.js?1691087856></script><script src=/js/perfect-scrollbar.min.js?1691087856></script><script src=/js/perfect-scrollbar.jquery.min.js?1691087856></script><script src=/js/jquery.sticky.js?1691087856></script><script src=/js/featherlight.min.js?1691087856></script><script src=/js/highlight.pack.js?1691087856></script><script>hljs.initHighlightingOnLoad();</script><script src=/js/modernizr.custom-3.6.0.js?1691087856></script><script src=/js/learn.js?1691087856></script><script src=/js/hugo-learn.js?1691087856></script></body></html>